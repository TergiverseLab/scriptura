<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>SCRIPTURA</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Cinzel+Decorative:wght@400;700&family=IM+Fell+English:ital@0;1&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,300;1,600&display=swap');
:root{
  --void:#04020a;--gold:#c9a227;--gold2:#edd06b;--dim:#3a2808;
  --cyan:#0aefcb;--cyan2:#5ffce0;--mag2:#ff80d8;
  --red:#e02840;--w:#f0e8d8;--w2:#d4c8a8;
  --side:188px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{width:100%;height:100%;overflow:hidden;background:var(--void);}
canvas{display:block;position:fixed;inset:0;z-index:0;}

/* ── SIDE PANELS ── */
#panel-l,#panel-r{
  position:fixed;top:0;bottom:0;z-index:20;width:var(--side);
  pointer-events:none;
}
#panel-l{left:0;border-right:1px solid rgba(10,239,203,.06);}
#panel-r{right:0;border-left:1px solid rgba(201,162,39,.06);}
.ptitle{
  position:absolute;top:6px;left:0;right:0;
  font-family:'Space Mono',monospace;font-size:6px;letter-spacing:.3em;
  text-align:center;opacity:.18;z-index:2;
}
#panel-l .ptitle{color:var(--cyan);}
#panel-r .ptitle{color:var(--gold);}

/* Constellation canvas — full panel, behind text */
.tree-cv{position:absolute;inset:0;width:100%;height:100%;z-index:1;display:block;}

/* AI-generated text overlay — readable, centered, above constellation */
.ai-text{
  position:absolute;inset:0;z-index:3;
  display:flex;flex-direction:column;justify-content:center;
  padding:32px 14px 20px;
  overflow:hidden;
}
.ai-text-inner{
  font-family:'IM Fell English',serif;
  font-style:italic;
  line-height:1.72;
  text-align:center;
  opacity:0;
  filter:blur(8px) brightness(1);
  transform:scale(.96);
  transition:opacity 1.1s ease, filter 1.1s ease, transform 1.0s ease;
  will-change:opacity,filter,transform;
}
#panel-l .ai-text-inner{
  font-size:14px;color:var(--cyan2);
  text-shadow:0 0 18px rgba(10,239,203,.22);
}
#panel-r .ai-text-inner{
  font-size:14px;color:var(--gold2);
  text-shadow:0 0 18px rgba(201,162,39,.22);
}
.ai-text-inner.entering{
  opacity:0;filter:blur(8px) brightness(1.8);transform:scale(1.03);
}
.ai-text-inner.visible{
  opacity:0.88;filter:blur(0) brightness(1);transform:scale(1);
}
.ai-label{
  position:absolute;bottom:8px;left:0;right:0;
  font-family:'Space Mono',monospace;font-size:6px;
  letter-spacing:.2em;text-align:center;opacity:.18;
}
#panel-l .ai-label{color:var(--cyan);}
#panel-r .ai-label{color:var(--gold);}

/* ── TOP HUD ── */
#hud-s{position:fixed;top:0;left:var(--side);right:var(--side);z-index:30;background:rgba(4,2,10,.97);border-bottom:1px solid rgba(10,239,203,.12);}
#sr1{display:flex;align-items:center;height:34px;font-family:'Space Mono',monospace;border-bottom:1px solid rgba(10,239,203,.05);}
.sc{display:flex;align-items:center;gap:7px;padding:0 12px;border-right:1px solid rgba(10,239,203,.06);}
.sc:last-child{border-right:none;}.sc.gx{flex:1;}
.sl{font-size:6px;letter-spacing:.26em;color:var(--cyan);opacity:.26;white-space:nowrap;}
#s-mis{font-size:13px;color:var(--cyan);font-family:'Cormorant Garamond',serif;font-style:italic;}
#s-lives{font-size:15px;color:var(--cyan);letter-spacing:.1em;}
#s-pts{font-size:12px;color:var(--cyan2);font-weight:700;}
#stbar{height:2px;background:rgba(10,239,203,.05);}
#sfill{height:100%;width:100%;background:var(--cyan);transition:width .1s linear;}
#sr2{min-height:40px;padding:6px 12px;display:flex;align-items:baseline;gap:10px;}
#splbl{font-size:6px;letter-spacing:.24em;color:var(--cyan);opacity:.22;font-family:'Space Mono',monospace;white-space:nowrap;padding-top:4px;flex-shrink:0;}
#spoem{flex:1;font-family:'IM Fell English',serif;font-style:italic;font-size:20px;color:var(--mag2);line-height:1.3;}
#spoem.empty{color:rgba(255,128,216,.14);font-size:14px;}

/* ── BOTTOM HUD ── */
#hud-w{position:fixed;bottom:0;left:var(--side);right:var(--side);z-index:30;background:rgba(4,2,10,.97);border-top:1px solid rgba(201,162,39,.12);}
#wr1{display:flex;align-items:center;height:30px;font-family:'Space Mono',monospace;border-bottom:1px solid rgba(201,162,39,.05);}
.wc{display:flex;align-items:center;gap:7px;padding:0 12px;border-right:1px solid rgba(201,162,39,.05);}
.wc:last-child{border-right:none;}.wc.gx{flex:1;}
.wl{font-size:6px;letter-spacing:.26em;color:var(--gold);opacity:.26;white-space:nowrap;}
#w-mis{font-size:13px;color:var(--gold2);font-family:'Cormorant Garamond',serif;font-style:italic;}
#w-lives{font-size:15px;color:var(--gold);letter-spacing:.1em;}
#w-pts{font-size:12px;color:var(--gold2);font-weight:700;}
#wtbar{height:2px;background:rgba(201,162,39,.05);}
#wfill{height:100%;width:100%;background:var(--gold);transition:width .1s linear;}
#wed-row{padding:7px 12px;display:flex;align-items:center;gap:9px;min-height:50px;}
#wsigil{font-size:18px;color:var(--dim);font-family:'Cinzel Decorative',serif;flex-shrink:0;}
#wed{flex:1;font-family:'Cormorant Garamond',serif;font-size:22px;line-height:1.4;min-height:26px;}
.edt{color:rgba(240,232,216,.85);}
.edc{display:inline-block;width:2px;height:24px;background:var(--gold);vertical-align:bottom;margin-left:2px;animation:blink .7s step-end infinite;}
@keyframes blink{50%{opacity:0}}
.edp{font-style:italic;background:linear-gradient(90deg,rgba(201,162,39,.2),rgba(237,208,107,.7),rgba(201,162,39,.2));background-size:200% 100%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shim 1.5s linear infinite;}
@keyframes shim{0%{background-position:200% 0}100%{background-position:-200% 0}}
#whint{font-size:7px;color:var(--dim);letter-spacing:.07em;flex-shrink:0;line-height:2;text-align:right;font-family:'Space Mono',monospace;}
#sabwarn{display:none;font-size:8px;letter-spacing:.1em;color:var(--mag2);flex-shrink:0;font-family:'Space Mono',monospace;animation:pw .65s ease-in-out infinite;}
@keyframes pw{0%,100%{opacity:.26}50%{opacity:1}}

/* ── TOASTS ── */
#toasts{position:fixed;top:80px;right:calc(var(--side) + 6px);z-index:60;display:flex;flex-direction:column;gap:4px;pointer-events:none;max-width:250px;}
.toast{background:rgba(4,2,10,.96);border-left:2px solid var(--gold);padding:5px 11px;line-height:1.5;font-family:'Space Mono',monospace;font-size:8px;letter-spacing:.04em;color:var(--w2);opacity:0;animation:tin .15s ease forwards,tout .25s ease 3.6s forwards;}
.toast .t1{font-size:8px;opacity:.55;margin-bottom:1px;}.toast .t2{font-size:13px;font-family:'Cormorant Garamond',serif;font-style:italic;font-weight:600;}
.tc{border-color:var(--cyan);color:var(--cyan2);}.tm{border-color:var(--mag2);color:var(--mag2);}.tg{border-color:var(--gold2);color:var(--gold2);}.tr{border-color:var(--red);color:#ff6070;}
@keyframes tin{from{opacity:0;transform:translateX(8px)}to{opacity:1;transform:none}}
@keyframes tout{to{opacity:0}}

/* ── AI ind ── */
#aiind{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:50;display:none;background:rgba(4,2,10,.9);border:1px solid rgba(10,239,203,.1);padding:7px 20px;font-family:'Space Mono',monospace;font-size:8px;letter-spacing:.22em;color:rgba(10,239,203,.38);}

/* ── OVERLAY ── */
#ov{position:fixed;inset:0;z-index:200;background:radial-gradient(ellipse at 50% 36%,#0d0535,#04020a 65%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;overflow-y:auto;padding:20px 0;}
#ov h1{font-family:'Cinzel Decorative',serif;font-weight:700;font-size:clamp(20px,4.5vw,56px);letter-spacing:.45em;color:var(--gold);text-shadow:0 0 45px rgba(201,162,39,.18);}
.osub{font-family:'Space Mono',monospace;font-size:8px;color:rgba(201,162,39,.28);letter-spacing:.08em;text-align:center;line-height:2.8;max-width:480px;}
.osub .c{color:var(--cyan2);}.osub .g{color:var(--gold2);}.osub .m{color:var(--mag2);}.osub .r{color:#ff7080;}
.osep{width:70px;height:1px;background:rgba(201,162,39,.06);flex-shrink:0;}

/* Difficulty */
.orow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:center;}
.olbl{font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.22em;color:rgba(201,162,39,.28);width:100%;text-align:center;}
.dbtn{background:transparent;border:1px solid rgba(201,162,39,.2);color:rgba(201,162,39,.4);font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.16em;padding:6px 14px;cursor:pointer;transition:.18s;}
.dbtn:hover,.dbtn.act{border-color:var(--gold);color:var(--gold2);background:rgba(201,162,39,.04);}

/* Mission editor */
#mis-ed{max-width:560px;width:100%;display:none;flex-direction:column;gap:6px;}
#mis-ed.open{display:flex;}
.med-tabs{display:flex;gap:0;border-bottom:1px solid rgba(201,162,39,.1);}
.mtab{font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.14em;padding:5px 12px;cursor:pointer;color:rgba(201,162,39,.35);border-bottom:2px solid transparent;transition:.15s;}
.mtab.act{color:var(--gold2);border-color:var(--gold2);}
.med-list{display:flex;flex-direction:column;gap:4px;max-height:180px;overflow-y:auto;padding:4px 0;}
.med-list::-webkit-scrollbar{width:3px;}.med-list::-webkit-scrollbar-track{background:transparent;}.med-list::-webkit-scrollbar-thumb{background:rgba(201,162,39,.2);}
.mrow{display:flex;gap:6px;align-items:flex-start;}
.mrow span{font-family:'Space Mono',monospace;font-size:7px;color:rgba(201,162,39,.3);padding-top:5px;flex-shrink:0;min-width:16px;}
.mrow input{flex:1;background:rgba(201,162,39,.04);border:1px solid rgba(201,162,39,.12);color:var(--w2);font-family:'Cormorant Garamond',serif;font-size:12px;padding:4px 7px;outline:none;}
.mrow input:focus{border-color:rgba(201,162,39,.3);}
.add-mis-btn{
  background:transparent;border:1px solid rgba(201,162,39,.18);
  color:rgba(201,162,39,.4);font-family:'Space Mono',monospace;font-size:7px;
  letter-spacing:.14em;padding:5px 10px;cursor:pointer;margin-top:4px;
  transition:.15s;align-self:flex-start;
}
.add-mis-btn:hover{border-color:var(--gold);color:var(--gold2);}

#ov-res{font-family:'Cormorant Garamond',serif;font-size:18px;letter-spacing:.12em;color:var(--w);text-align:center;line-height:2.2;}
.obtn{background:transparent;border:1px solid rgba(201,162,39,.24);color:var(--gold);font-family:'Space Mono',monospace;font-size:8px;letter-spacing:.28em;padding:9px 24px;cursor:pointer;transition:.2s;}
.obtn:hover{border-color:var(--gold);color:var(--gold2);}
.osmall{font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.18em;color:rgba(201,162,39,.28);cursor:pointer;text-decoration:none;transition:.15s;}
.osmall:hover{color:var(--gold2);}

/* API key input */
.apikey-wrap{display:flex;flex-direction:column;align-items:center;gap:6px;width:100%;max-width:420px;}
.apikey-wrap label{font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.22em;color:rgba(201,162,39,.4);}
.apikey-row{display:flex;gap:6px;width:100%;}
#apikeyinput{
  flex:1;background:rgba(201,162,39,.04);border:1px solid rgba(201,162,39,.18);
  color:var(--w2);font-family:'Space Mono',monospace;font-size:10px;
  padding:7px 10px;outline:none;letter-spacing:.06em;
}
#apikeyinput:focus{border-color:rgba(201,162,39,.4);}
#apikeyinput::placeholder{color:rgba(201,162,39,.2);}
.apikey-ok{
  background:transparent;border:1px solid rgba(201,162,39,.24);color:var(--gold);
  font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.16em;
  padding:7px 12px;cursor:pointer;transition:.18s;white-space:nowrap;
}
.apikey-ok:hover{border-color:var(--gold);color:var(--gold2);}
#apikey-status{font-family:'Space Mono',monospace;font-size:7px;letter-spacing:.12em;min-height:14px;}
.aks-ok{color:rgba(10,239,203,.6);}
.aks-err{color:rgba(224,40,64,.7);}
.aks-hint{color:rgba(201,162,39,.3);}
</style>
</head>
<body>
<canvas id="c"></canvas>

<!-- LEFT PANEL: snake poem (cyan) -->
<div id="panel-l">
  <div class="ptitle">POEMA · SERPIENTE</div>
  <canvas class="tree-cv" id="tcl"></canvas>
  <div class="ai-text">
    <div class="ai-text-inner" id="poem-text"></div>
  </div>
  <div class="ai-label">POEMA GENERADO</div>
</div>
<!-- RIGHT PANEL: writer story (gold) -->
<div id="panel-r">
  <div class="ptitle">HISTORIA · ESCRITOR</div>
  <canvas class="tree-cv" id="tcr"></canvas>
  <div class="ai-text">
    <div class="ai-text-inner" id="story-text"></div>
  </div>
  <div class="ai-label">HISTORIA GENERADA</div>
</div>

<!-- SERPIENTE HUD -->
<div id="hud-s">
  <div id="sr1">
    <div class="sc"><span class="sl">SERPIENTE</span><span id="s-lives">♦♦♦</span><span id="s-pts">0</span></div>
    <div class="sc gx"><span class="sl">MISIÓN</span><span id="s-mis">—</span></div>
    <div class="sc"><span style="font-size:7px;color:rgba(10,239,203,.18);font-family:'Space Mono',monospace;letter-spacing:.04em">↑↓←→ · cruza para devorar</span></div>
  </div>
  <div id="stbar"><div id="sfill"></div></div>
  <div id="sr2"><span id="splbl">VERSO</span><div id="spoem" class="empty">· · ·</div></div>
</div>

<!-- ESCRITOR HUD -->
<div id="hud-w">
  <div id="wr1">
    <div class="wc"><span class="wl">ESCRITOR</span><span id="w-lives">♦♦♦</span><span id="w-pts">0</span></div>
    <div class="wc gx"><span class="wl">MISIÓN</span><span id="w-mis">—</span></div>
    <div class="wc"><span id="ddisp" style="font-size:7px;font-family:'Space Mono',monospace;letter-spacing:.12em;color:rgba(201,162,39,.3)">—</span></div>
  </div>
  <div id="wtbar"><div id="wfill"></div></div>
  <div id="wed-row">
    <span id="wsigil">ℵ</span>
    <div id="wed"></div>
    <span id="sabwarn">⊗ SABOTAJE</span>
    <div id="whint">SPC·confirma<br>ENTER·valida<br><span style="color:var(--red)">●</span>borra·<span style="color:var(--mag2)">●</span>sab</div>
  </div>
</div>

<div id="toasts"></div>
<div id="aiind">· validando ·</div>

<div id="ov">
  <h1>SCRIPTURA</h1>
  <div class="osub">
    <span class="g">ESCRITOR</span> — responde la misión · <span class="g">SPC</span> confirma · <span class="g">ENTER</span> valida<br>
    texto validado → letras doradas en la serpiente · la serpiente puede devorarlas<br>
    <span class="c">SERPIENTE</span> — <span class="c">↑↓←→</span> · cruza el cuerpo · verso se valida al acabar el tiempo<br>
    <span class="r">● roja</span> borra verso · <span class="m">● magenta</span> sabotaje 6s
  </div>
  <div class="osep"></div>
  <div class="olbl">NIVEL DE CRÍTICA</div>
  <div class="orow">
    <button class="dbtn act" onclick="setDiff('flex',this)">FLEXIBLE</button>
    <button class="dbtn" onclick="setDiff('mod',this)">MODERADO</button>
    <button class="dbtn" onclick="setDiff('strict',this)">EXIGENTE</button>
    <button class="dbtn" onclick="setDiff('hard',this)">HARDCORE</button>
  </div>
  <div class="osep"></div>
  <a class="osmall" onclick="toggleMisEd()">▸ editar misiones</a>
  <div id="mis-ed">
    <div class="med-tabs">
      <div class="mtab act" data-which="s" onclick="showMisTab('s',this)">SERPIENTE</div>
      <div class="mtab" data-which="w" onclick="showMisTab('w',this)">ESCRITOR</div>
    </div>
    <div class="med-list" id="ml-s"></div>
    <div class="med-list" id="ml-w" style="display:none"></div>
  </div>
  <div class="osep"></div>
  <div class="apikey-wrap">
    <label>GROQ API KEY · <a style="color:inherit;opacity:.7" href="https://console.groq.com/keys" target="_blank">obtener gratis →</a></label>
    <div class="apikey-row">
      <input id="apikeyinput" type="password" placeholder="AIza..." autocomplete="off" oninput="onKeyInput()">
      <button class="apikey-ok" onclick="saveKey()">✓ GUARDAR</button>
      <button class="apikey-ok" onclick="testKey()" id="test-btn" style="border-color:rgba(10,239,203,.24);color:rgba(10,239,203,.5)">PROBAR</button>
    </div>
    <div id="apikey-status" class="aks-hint">introduce tu clave para jugar</div>
  </div>
  <div class="osep"></div>
  <div id="ov-res"></div>
  <button class="obtn" id="start-btn" onclick="startGame()" disabled style="opacity:.35;cursor:not-allowed">▶ INICIAR</button>
</div>

<script>
'use strict';

// ══════════════════════════════════════════
// CONFIG
// ══════════════════════════════════════════
const SZ=20,SPD=12,W_TIME=80,S_TIME=50,LIVES=3,MIN_VER=3,MAX_SNK=120,MAX_DISP=80;
const LERP_MS=(1000/SPD)*0.7;
const BG_POOL='אבגדהוזחטיכלמנסעפצקרשת◈◉△▽✦☽☿♄♃♂☉♀⬡⊕⊗∞∴⊛⌬⍟⎔⏣ψΩΣΔΛ';
const SIDE=188;

// Play area bounds — anchored to SZ grid so snake/apple coords always match
let GL=0,GR=0,GT=0,GB=0; // grid left/right/top/bottom (multiples of SZ)
function updateGrid(){
  GL=Math.ceil(SIDE/SZ)*SZ;
  GR=Math.floor((W-SIDE)/SZ)*SZ-SZ;
  GT=Math.ceil(TOP/SZ)*SZ;
  GB=Math.floor((H-BOT)/SZ)*SZ-SZ;
}

// ── Difficulty ───────────────────────────
let difficulty='flex';
const DLABEL={flex:'FLEXIBLE',mod:'MODERADO',strict:'EXIGENTE',hard:'HARDCORE'};
const DPROMPT={
  flex:'Sé GENEROSO. Aprueba si el texto toca el tema de alguna manera, aunque sea vaga o indirecta. Solo rechaza si está completamente vacío o es una evasión total.',
  mod: 'Sé MODERADO. Aprueba si hay al menos un detalle concreto que muestre que el jugador pensó en la pregunta. Rechaza si es tan genérico que podría aplicarse a cualquier historia.',
  strict:'Sé EXIGENTE. Aprueba solo si hay un detalle concreto y específico: un nombre, un lugar reconocible, un objeto físico, una acción precisa. Rechaza si el texto es vago o intercambiable con cualquier otra historia.',
  hard:'Sé IMPLACABLE. Exige al menos DOS detalles concretos e irrepetibles que solo podrían pertenecer a ESTA historia: nombres propios, lugares específicos, objetos con descripción física, acciones con consecuencias. Rechaza sin piedad cualquier generalización, metáfora vacía o respuesta que podría valer para otra historia.',
};
function setDiff(d,btn){difficulty=d;document.querySelectorAll('.dbtn').forEach(b=>b.classList.remove('act'));btn.classList.add('act');}

// ── Missions (mutable, shuffled each game) ─
const WM_DEF=[
  // Personaje
  {t:'¿quién es el protagonista?',          c:'Menciona un nombre, apodo o rasgo concreto. Ejemplo inválido: "hay una persona".'},
  {t:'¿qué desea con más fuerza?',          c:'Un deseo específico y concreto, no genérico. Ejemplo inválido: "quiere ser feliz".'},
  {t:'¿qué oculta a los demás?',            c:'Un secreto o mentira específica. Ejemplo inválido: "guarda un secreto".'},
  // Lugar y atmósfera
  {t:'¿dónde ocurre la historia?',          c:'Un lugar con al menos un detalle sensorial concreto. Ejemplo inválido: "en una ciudad".'},
  {t:'¿qué hora del día o estación es?',    c:'Momento temporal con al menos un detalle ambiental. Ejemplo inválido: "es de noche".'},
  {t:'¿qué objeto es central en la escena?',c:'Un objeto con un detalle físico que lo haga reconocible. Ejemplo inválido: "hay un objeto".'},
  // Conflicto y acción
  {t:'¿qué acaba de pasar?',                c:'Un evento concreto reciente. Ejemplo inválido: "pasó algo importante".'},
  {t:'¿qué está a punto de pasar?',         c:'Una acción o evento inminente específico. Ejemplo inválido: "algo va a ocurrir".'},
  {t:'¿qué se ha perdido o roto?',          c:'Algo concreto que se perdió, rompió o terminó. Ejemplo inválido: "algo se perdió".'},
  {t:'¿quién se opone al protagonista?',    c:'Un antagonista, obstáculo o tensión concreta. Ejemplo inválido: "hay un problema".'},
  // Relaciones
  {t:'¿qué le dijo alguien que no olvida?', c:'Una frase específica y quién la dijo. Ejemplo inválido: "alguien le dijo algo".'},
  {t:'¿a quién espera o busca?',            c:'Una persona concreta con al menos un rasgo. Ejemplo inválido: "espera a alguien".'},
  // Giro y resolución
  {t:'¿qué descubre en este momento?',      c:'Un descubrimiento o revelación específica. Ejemplo inválido: "descubre algo".'},
  {t:'¿cómo termina (o podría terminar)?',  c:'Un final o desenlace concreto. Ejemplo inválido: "termina de alguna manera".'},
  // Tono y voz
  {t:'¿cuál es el tono emocional?',         c:'Una emoción dominante con una imagen o situación concreta que la muestre.'},
  {t:'¿qué metáfora define la historia?',   c:'Una metáfora o imagen concreta que capture la esencia. Ejemplo inválido: "es una metáfora de la vida".'},
];
const SM_DEF=[
  {t:'contiene un adjetivo',        c:'El verso contiene al menos un adjetivo reconocible.'},
  {t:'contiene un verbo',           c:'El verso contiene al menos un verbo conjugado o en infinitivo.'},
  {t:'contiene un color',           c:'El verso menciona explícitamente al menos un color.'},
  {t:'contiene un número',          c:'El verso contiene al menos un número o cantidad.'},
  {t:'algo evocador',               c:'El verso evoca una imagen, sensación o atmósfera, aunque sea vaga.'},
  {t:'suena bien en voz alta',      c:'El verso tiene cierta musicalidad o ritmo, aunque sea mínimo.'},
  {t:'contiene una preposición',    c:'El verso contiene al menos una preposición (en, de, con, sin, por...).'},
  {t:'tiene más de 3 palabras',     c:'El verso contiene al menos 4 palabras distintas.'},
  {t:'algo misterioso',             c:'El verso sugiere algo inexplicado, ambiguo o enigmático.'},
  {t:'contiene un sustantivo',      c:'El verso contiene al menos un sustantivo reconocible.'},
];
let WM=[],SM=[];
function shuffleMissions(){
  WM=[...WM_DEF].sort(()=>Math.random()-.5);
  SM=[...SM_DEF].sort(()=>Math.random()-.5);
}
// Read edits from inputs
function getMissions(which){
  const el=document.getElementById('ml-'+which);if(!el)return;
  const inputs=el.querySelectorAll('.mrow input');
  const arr=which==='s'?SM:WM;
  inputs.forEach((inp,i)=>{if(arr[i])arr[i].t=inp.value||arr[i].t;});
}
function addMisRow(which){
  getMissions(which); // save current edits first
  const arr=which==='s'?SM:WM;
  arr.push({t:'nueva misión',c:'Respuesta concreta y específica.'});
  buildMisInputs();
  showMisTab(which,document.querySelector(`.mtab[data-which="${which}"]`));
}
function buildMisInputs(){
  ['s','w'].forEach(which=>{
    const arr=which==='s'?SM:WM;
    const el=document.getElementById('ml-'+which);
    el.innerHTML='';
    arr.forEach((m,i)=>{
      const row=document.createElement('div');row.className='mrow';
      row.innerHTML=`<span>${i+1}</span><input value="${esc(m.t)}" placeholder="misión ${i+1}">`;
      el.appendChild(row);
    });
    const addBtn=document.createElement('button');
    addBtn.className='add-mis-btn';addBtn.textContent='+ añadir';
    addBtn.onclick=()=>addMisRow(which);
    el.appendChild(addBtn);
  });
}
function toggleMisEd(){
  const el=document.getElementById('mis-ed');
  el.classList.toggle('open');
  if(el.classList.contains('open'))buildMisInputs();
}
function showMisTab(which,btn){
  document.querySelectorAll('.mtab').forEach(t=>t.classList.remove('act'));btn.classList.add('act');
  document.getElementById('ml-s').style.display=which==='s'?'flex':'none';
  document.getElementById('ml-w').style.display=which==='w'?'flex':'none';
}

// ══════════════════════════════════════════
// CANVAS
// ══════════════════════════════════════════
const CV=document.getElementById('c');
const CX=CV.getContext('2d');
let W=0,H=0,cachedVig=null,TOP=76,BOT=106;
function resize(){
  W=CV.width=innerWidth;H=CV.height=innerHeight;cachedVig=null;
  const hs=document.getElementById('hud-s');
  const hw=document.getElementById('hud-w');
  TOP=hs?hs.offsetHeight:76;BOT=hw?hw.offsetHeight:106;
  updateGrid();
  // Resize tree canvases to match panel dimensions
  ['tcl','tcr'].forEach(id=>{
    const cv=document.getElementById(id);
    if(cv){
      const pw=cv.clientWidth||SIDE;
      const ph=cv.clientHeight||H||window.innerHeight;
      cv.width=pw;cv.height=ph;
    }
  });
}
window.addEventListener('resize',()=>{resize();initBg();drawConstellations();});

// ══════════════════════════════════════════
// TEXT MODEL
// ══════════════════════════════════════════
let validated_buf='',pending_text='',editor_buf='',current_word='',sabotage=false;
function snakeText(){
  let t=validated_buf;
  if(pending_text)t=t?t+' '+pending_text:pending_text;
  if(sabotage&&editor_buf)t=t?t+' '+editor_buf:editor_buf;
  return t;
}
function segChars(){
  // snake[0]=head should display t[0] (first/oldest char)
  // snake[n-1]=tail should display t[n-1] (newest char)
  // When text grows longer than snake, show the FIRST n chars
  // (oldest text rides head→neck, newest rides near tail as it grows)
  const t=snakeText(),n=snake.length;
  if(!t)return ' '.repeat(Math.max(n,1));
  // Show first n chars so head carries start of text
  const vis=t.length>n?t.slice(0,n):t;
  return vis.length<n?vis.padEnd(n,' '):vis;
}
function zoneEnds(){
  const valEnd=validated_buf.length;
  return{valEnd,pendEnd:valEnd+(validated_buf&&pending_text?1:0)+pending_text.length};
}

// ══════════════════════════════════════════
// STATE
// ══════════════════════════════════════════
let snake=[],dir='RIGHT',nDir='RIGHT';
let headX=0,headY=0,prevX=0,prevY=0,lerpT=1,lastMov=0;
let verse=[],appleR=null,appleM=null;
let sLiv=LIVES,wLiv=LIVES,sPts=0,wPts=0,sMis=0,wMis=0,sTick=0,wTick=0;
let running=false,aiPending=false,verseTimerDone=false;
let particles=[],floaters=[],bgGlyphs=[],shk=0,lastTA=0;

// ══════════════════════════════════════════
// INIT
// ══════════════════════════════════════════
function initSnake(){
  const sx=GL+Math.floor((GR-GL)/2/SZ)*SZ;
  const sy=GT+Math.floor((GB-GT)/2/SZ)*SZ;
  snake=[[sx,sy],[sx-SZ,sy],[sx-2*SZ,sy],[sx-3*SZ,sy]];
  headX=sx;headY=sy;prevX=sx-SZ;prevY=sy;lerpT=1;
  dir='RIGHT';nDir='RIGHT';
  validated_buf='';pending_text='';editor_buf='';current_word='';
  sabotage=false;verse=[];
}
function initBg(){
  bgGlyphs=[];
  for(let i=0;i<16;i++) bgGlyphs.push({
    x:GL+Math.random()*(GR-GL),y:Math.random()*H,
    ch:BG_POOL[Math.floor(Math.random()*BG_POOL.length)],
    a:.003+Math.random()*.011,sz:10+Math.random()*17,
    ph:Math.random()*Math.PI*2,sp:.00014+Math.random()*.00055,
    dx:(Math.random()-.5)*.008,
  });
}

// ══════════════════════════════════════════
// MOVEMENT
// ══════════════════════════════════════════
function adv(x,y,d){
  let nx=x,ny=y;
  if(d==='RIGHT')nx+=SZ; else if(d==='LEFT')nx-=SZ;
  else if(d==='UP')ny-=SZ; else ny+=SZ;
  if(nx<GL)nx=GR; if(nx>GR)nx=GL;
  if(ny<GT)ny=GB; if(ny>GB)ny=GT;
  return[nx,ny];
}
function findHit(nx,ny){
  for(let i=2;i<snake.length;i++)if(snake[i][0]===nx&&snake[i][1]===ny)return i;
  return -1;
}

// ══════════════════════════════════════════
// DEVORAR
// ══════════════════════════════════════════
function devorar(hitIdx,newHead){
  const sc=segChars(),ch=sc[hitIdx]||' ';
  if(ch===' '){snake.unshift(newHead);snake.pop();return;}
  let L=hitIdx,R=hitIdx+1;
  while(L>0&&sc[L-1]!==' ')L--;
  while(R<sc.length&&sc[R]!==' ')R++;
  const word=sc.slice(L,R).trim();
  const st=snakeText(),nb=snake.length;
  const off=0; // segChars returns t[0..n], pos=i directly
  const posInT=off+L;
  const{valEnd,pendEnd}=zoneEnds();
  if(pending_text&&posInT>=valEnd&&posInT<pendEnd){snake.unshift(newHead);snake.pop();return;}
  if(!sabotage&&posInT>=pendEnd){snake.unshift(newHead);snake.pop();return;}
  // Burst FX (no shadowBlur here — just particles)
  for(let i=L;i<R;i++){
    if(!snake[i])continue;
    const[sx,sy]=snake[i];
    floaters.push({x:sx+SZ/2,y:sy+SZ/2,ch:sc[i]||'·',color:'#0aefcb',life:1,vy:-0.9-Math.random()*.5,vx:(Math.random()-.5)*0.6});
    for(let j=0;j<2;j++){const a=Math.random()*Math.PI*2,s=1+Math.random()*2;particles.push({x:sx+SZ/2,y:sy+SZ/2,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:.04,color:'#0aefcb',sz:1.4});}
  }
  shk=3;snake.splice(L,R-L);
  if(posInT<valEnd){
    const cL=off+L,cR=off+R;
    const stCL=Math.min(cL,validated_buf.length),stCR=Math.min(cR,validated_buf.length);
    validated_buf=(validated_buf.slice(0,stCL)+validated_buf.slice(stCR)).replace(/\s{2,}/g,' ').trim();
  } else if(sabotage&&posInT>=pendEnd){
    const eC=Math.max(0,(off+L)-pendEnd),eCR=eC+(R-L),eb=editor_buf;
    editor_buf=(eb.slice(0,Math.min(eC,eb.length))+eb.slice(Math.min(eCR,eb.length))).replace(/\s{2,}/g,' ').trim();
    current_word='';
  }
  if(word){verse.push(word);renderVerse();}
  snake.unshift(newHead);renderEditor();
}

// ══════════════════════════════════════════
// TICK
// ══════════════════════════════════════════
function tickSnake(now){
  lastMov=now;dir=nDir;
  const[nx,ny]=adv(...snake[0],dir);
  prevX=snake[0][0];prevY=snake[0][1];lerpT=0;
  const hit=findHit(nx,ny);
  // Always check apples, regardless of body hit
  const hitR=appleR&&nx===appleR.x&&ny===appleR.y;
  const hitM=appleM&&nx===appleM.x&&ny===appleM.y;
  if(hit>=2){
    devorar(hit,[nx,ny]);headX=snake[0][0];headY=snake[0][1];
    if(hitR)eatAppleR();
    if(hitM)eatAppleM();
    return;
  }
  snake.unshift([nx,ny]);
  if(snake.length>MAX_SNK)snake.length=MAX_SNK;else snake.pop();
  headX=nx;headY=ny;
  if(hitR)eatAppleR();
  if(hitM)eatAppleM();
}

// ══════════════════════════════════════════
// TYPING
// ══════════════════════════════════════════
function typeLetter(ch){if(pending_text)return;current_word+=ch;renderEditor();}
function confirmWord(){
  if(pending_text)return;
  const w=current_word.trim();if(!w)return;
  editor_buf=(editor_buf?editor_buf+' ':'')+w;current_word='';renderEditor();
}
function doBackspace(){
  if(pending_text)return;
  if(current_word.length>0)current_word=current_word.slice(0,-1);
  else if(editor_buf.length>0)editor_buf=editor_buf.replace(/\s+$/,'').slice(0,-1).replace(/\s+$/,'');
  renderEditor();
}

// ══════════════════════════════════════════
// AI
// ══════════════════════════════════════════
// ══════════════════════════════════════════
// API KEY MANAGEMENT
// ══════════════════════════════════════════
let geminiKey = '';
function onKeyInput(){
  const v=document.getElementById('apikeyinput').value.trim();
  const st=document.getElementById('apikey-status');
  if(!v){st.textContent='introduce tu clave para jugar';st.className='aks-hint';}
  else{st.textContent='pulsa GUARDAR para confirmar';st.className='aks-hint';}
}
async function testKey(){
  const v=document.getElementById('apikeyinput').value.trim();
  const st=document.getElementById('apikey-status');
  if(!v){st.textContent='introduce una clave primero';st.className='aks-err';return;}
  st.textContent='· probando conexión ·';st.className='aks-hint';
  const tempKey=geminiKey;
  geminiKey=v;
  try{
    const r=await groqCall('Responde solo: OK',20);
    if(r){
      st.textContent='✓ conexión correcta · guarda para jugar';st.className='aks-ok';
    }
  }catch(e){
    st.textContent=`✗ ${e.message}`;st.className='aks-err';
    geminiKey=tempKey;
    return;
  }
  geminiKey=tempKey; // don't save yet, let saveKey do it
}
function saveKey(){
  const v=document.getElementById('apikeyinput').value.trim();
  const st=document.getElementById('apikey-status');
  const btn=document.getElementById('start-btn');
  if(!v.startsWith('gsk_')||v.length<20){
    st.textContent='✗ clave no válida (debe empezar por gsk_...)';st.className='aks-err';return;
  }
  geminiKey=v;
  try{sessionStorage.setItem('gkey',v);}catch(e){}
  st.textContent='✓ clave guardada · puedes iniciar';st.className='aks-ok';
  btn.disabled=false;btn.style.opacity='1';btn.style.cursor='pointer';
}
// Restore key from session if available
(()=>{
  try{
    const k=sessionStorage.getItem('gkey');
    if(k&&k.startsWith('gsk_')&&k.length>=20){
      geminiKey=k;
      document.getElementById('apikeyinput').value=k;
      document.getElementById('apikey-status').textContent='✓ clave restaurada';
      document.getElementById('apikey-status').className='aks-ok';
      const btn=document.getElementById('start-btn');
      btn.disabled=false;btn.style.opacity='1';btn.style.cursor='pointer';
    }
  }catch(e){}
})();

// ══════════════════════════════════════════
// GROQ API — free, 30 req/min, sin tarjeta
// ══════════════════════════════════════════
const GROQ_URL='https://api.groq.com/openai/v1/chat/completions';
const GROQ_MODEL='llama-3.1-8b-instant';

async function groqCall(prompt, maxTokens=180){
  if(!geminiKey)throw new Error('sin clave');
  const res=await fetch(GROQ_URL,{
    method:'POST',
    headers:{
      'Content-Type':'application/json',
      'Authorization':`Bearer ${geminiKey}`
    },
    body:JSON.stringify({
      model:GROQ_MODEL,
      messages:[{role:'user',content:prompt}],
      max_tokens:maxTokens,
      temperature:0.7
    })
  });
  if(!res.ok){
    let msg=`HTTP ${res.status}`;
    try{const e=await res.json();msg=e?.error?.message||msg;}catch(x){}
    if(res.status===401)throw new Error('API key inválida');
    if(res.status===429)throw new Error('límite de llamadas · espera un momento');
    throw new Error(msg);
  }
  const d=await res.json();
  return d.choices?.[0]?.message?.content||'';
}

// callAI — expects JSON response
async function callAI(prompt){
  const raw=await groqCall(prompt,150);
  const txt=raw.replace(/```json|```/g,'').trim();
  try{return JSON.parse(txt);}
  catch(e){
    const m=txt.match(/\{[\s\S]*?\}/);
    if(m)try{return JSON.parse(m[0]);}catch(e2){}
    return{pass:false,feedback:'error de formato'};
  }
}

// callAIRaw — plain text response
async function callAIRaw(prompt){
  return await groqCall(prompt,300);
}

// ══════════════════════════════════════════
// WRITER SUBMIT
// ══════════════════════════════════════════
async function writerSubmit(){
  if(aiPending||pending_text)return;
  // Read any edits
  getMissions('w');
  const full=(editor_buf+(editor_buf&&current_word?' ':'')+current_word).trim();
  if(full.split(/\s+/).filter(Boolean).length<4){toast('mínimo 4 palabras','tr');return;}
  pending_text=full;editor_buf='';current_word='';
  renderEditor();aiPending=true;showAI(true);
  try{
    const m=WM[wMis%WM.length];
    const r=await callAI(
`Árbitro de escritura narrativa.
MISIÓN: "${m.t}"
CONDICIÓN: "${m.c}"
TEXTO: "${full.slice(-500)}"
NIVEL DE CRÍTICA: ${DPROMPT[difficulty]}
Responde SOLO JSON sin markdown: {"pass":true/false,"feedback":"≤8 palabras español"}`);
    if(r.pass){
      wPts++;
      const chars=Math.min(pending_text.length,MAX_SNK-snake.length);
      const tail=snake[snake.length-1];
      for(let i=0;i<chars;i++)snake.push([tail[0],tail[1]]);
      validated_buf=(validated_buf?validated_buf+' ':'')+pending_text;
      pending_text='';
      addFragment(full,'r');triggerDissolve(full);
      wMis++;wTick=performance.now();
      renderWriterMission();updatePts();
      toast(`✦ ${r.feedback||'validado'}\n+1 · texto en la serpiente`,'tg',true);
    } else {
      editor_buf=pending_text;pending_text='';
      toast(r.feedback||'no cumple la misión','tr');
    }
  }catch(e){
    const msg=e.message||'';
    if(msg.includes('API_KEY')||msg.includes('sin clave'))toast('API key inválida o sin permisos','tr');
    else toast('error de conexión','tr');
    editor_buf=pending_text;pending_text='';
  }
  aiPending=false;showAI(false);renderEditor();
}

// ══════════════════════════════════════════
async function autoValidateVerse(){
  getMissions('s');
  if(verse.length<MIN_VER){
    sLiv=Math.max(0,sLiv-1);updateLives();
    toast('verso insuficiente · −1 vida','tm');
    if(!sLiv){gameOver();return;}
    verse=[];renderVerse();sTick=performance.now();verseTimerDone=false;return;
  }
  const sent=verse.join(' ');
  aiPending=true;showAI(true);
  try{
    const r=await callAI(
`Evalúa este fragmento de texto formado aleatoriamente en un juego: "${sent}"

CRITERIO: ¿Suena bien y tiene coherencia mínima?

RECHAZAR si:
- Hay artículos o determinantes repetidos seguidos sin nada entre ellos ("el el", "la la", "un un")
- Hay más de dos preposiciones o conjunciones seguidas sin sustantivo ni verbo
- El resultado es completamente discordante y no evoca nada (pura cadena de partículas funcionales)

ACEPTAR si:
- Las palabras forman algo que podría leerse en voz alta sin sonar absurdo
- Tiene al menos un sustantivo o verbo reconocible
- Es fragmentario o poético pero tiene alguna imagen o sentido, aunque sea mínimo
- En caso de duda genuina, ACEPTAR

Responde SOLO JSON: {"pass":true/false,"reading":"frase poética ≤6 palabras que captura la esencia"}`);
    if(r.pass){
      sPts++;addFragment(sent,'l');
      for(let j=0;j<12;j++){const a=Math.random()*Math.PI*2,s=1.3+Math.random()*2.2;particles.push({x:snake[0][0]+SZ/2,y:snake[0][1]+SZ/2,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:.03,color:'#0aefcb',sz:1.8});}
      toast(`◈ ${sent}\n${r.reading||'válido'} · +1`,'tc',true);
      updatePts();
    } else {
      sLiv=Math.max(0,sLiv-1);updateLives();
      toast(`${r.reading||'no cumple'} · −1 vida`,'tm');
      if(!sLiv){aiPending=false;showAI(false);gameOver();return;}
    }
  }catch(e){toast(e.message||'error de conexión','tr');}
  sMis++;verse=[];renderVerse();sTick=performance.now();renderSnakeMission();
  aiPending=false;showAI(false);verseTimerDone=false;
}

// ══════════════════════════════════════════
// APPLES — placed only in play area
// ══════════════════════════════════════════
function placeApples(){
  const occ=new Set(snake.map(s=>s[0]+','+s[1]));
  const cols=Math.round((GR-GL)/SZ)+1;
  const rows=Math.round((GB-GT)/SZ)+1;
  if(!appleR){for(let i=0;i<1200;i++){
    const x=GL+Math.floor(Math.random()*cols)*SZ;
    const y=GT+Math.floor(Math.random()*rows)*SZ;
    const k=x+','+y;
    if(!occ.has(k)&&!(appleM&&appleM.x===x&&appleM.y===y)){appleR={x,y};break;}
  }}
  if(!appleM){for(let i=0;i<1200;i++){
    const x=GL+Math.floor(Math.random()*cols)*SZ;
    const y=GT+Math.floor(Math.random()*rows)*SZ;
    const k=x+','+y;
    if(!occ.has(k)&&!(appleR&&appleR.x===x&&appleR.y===y)){appleM={x,y};break;}
  }}
}
function pb(x,y,color,n){for(let j=0;j<n;j++){const a=Math.random()*Math.PI*2,s=1.4+Math.random()*2.2;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,life:1,decay:.042,color,sz:1.6});}}
function eatAppleR(){pb(appleR.x+SZ/2,appleR.y+SZ/2,'#e02840',7);shk=3;appleR=null;verse=[];renderVerse();sTick=performance.now();toast('● verso borrado','tr');setTimeout(placeApples,3500);}
function eatAppleM(){pb(appleM.x+SZ/2,appleM.y+SZ/2,'#d930b0',7);shk=3;appleM=null;sabotage=true;document.getElementById('sabwarn').style.display='inline';toast('⊗ SABOTAJE · 6s','tm');setTimeout(()=>{sabotage=false;document.getElementById('sabwarn').style.display='none';toast('sabotaje terminado','tm');setTimeout(placeApples,3000);},6000);}

// ══════════════════════════════════════════
// TIMERS
// ══════════════════════════════════════════
function updateTimers(now){
  if(now-lastTA<80)return;lastTA=now;
  const wf=Math.max(0,1-(now-wTick)/(W_TIME*1000));
  const wEl=document.getElementById('wfill');
  wEl.style.width=(wf*100)+'%';wEl.style.background=wf<.2?'#e02840':wf<.45?'#b07010':'#c9a227';
  if(wf<=0&&running){
    // Always reset tick to avoid cascade — penalty only if not validating and has text
    if(!pending_text&&!aiPending){
      const words=(editor_buf+' '+current_word).trim().split(/\s+/).filter(Boolean);
      if(words.length>=3){
        wLiv=Math.max(0,wLiv-1);updateLives();
        toast('tiempo agotado · −1 vida','tr');
        if(!wLiv){gameOver();return;}
      }
      editor_buf='';current_word='';renderEditor();
    }
    wTick=now; // always reset, even if skipped due to pending
  }
  const sf=Math.max(0,1-(now-sTick)/(S_TIME*1000));
  const sEl=document.getElementById('sfill');
  sEl.style.width=(sf*100)+'%';sEl.style.background=sf<.2?'#e02840':sf<.45?'#702090':'#0aefcb';
  if(sf<=0&&running&&!verseTimerDone&&!aiPending){verseTimerDone=true;autoValidateVerse();}
}

// ══════════════════════════════════════════
// CONSTELLATION + AI TEXT PANELS
// ══════════════════════════════════════════
// 10 sephirot positions [0..1] fractions
const SX=[.5,.22,.78,.5,.22,.78,.5,.22,.78,.5];
const SY=[.05,.14,.14,.25,.37,.37,.5,.62,.62,.76];
const SEDGES=[[0,1],[0,2],[1,2],[1,3],[2,3],[1,4],[2,5],[3,4],[3,5],[3,6],[4,5],[4,7],[5,8],[6,7],[6,8],[7,8],[7,9],[8,9]];

// State per panel
let pState={
  l:{nodes:Array(10).fill(null).map(()=>({active:false,glow:0})),fragments:[],aiText:'',aiPending:false},
  r:{nodes:Array(10).fill(null).map(()=>({active:false,glow:0})),fragments:[],aiText:'',aiPending:false},
};

function clearPanels(){
  ['l','r'].forEach(side=>{
    pState[side].nodes.forEach(n=>{n.active=false;n.glow=0;});
    pState[side].fragments=[];
    pState[side].aiText='';
    pState[side].aiPending=false;
    const el=document.getElementById(side==='l'?'poem-text':'story-text');
    if(el){el.textContent='';el.classList.remove('visible');}
  });
  drawConstellations();
}

function addFragment(text,side){
  const st=pState[side];
  st.fragments.push(text);
  // Activate next node
  const idx=st.nodes.findIndex(n=>!n.active);
  const slot=idx>=0?idx:st.nodes.length-1;
  if(idx<0){
    // shift left, recycle last
    for(let i=0;i<st.nodes.length-1;i++)st.nodes[i]=Object.assign({},st.nodes[i+1]);
  }
  st.nodes[slot].active=true;
  st.nodes[slot].glow=0;
  // Animate glow up
  const t0=performance.now();
  const anim=()=>{
    const p=Math.min(1,(performance.now()-t0)/800);
    st.nodes[slot].glow=p;
    drawConstellations();
    if(p<1)requestAnimationFrame(anim);
  };
  requestAnimationFrame(anim);
  // Generate AI text (debounced)
  scheduleAIText(side);
}

// Debounce AI generation — wait 1.2s after last fragment
let aiTextTimers={l:null,r:null};
function scheduleAIText(side){
  if(aiTextTimers[side])clearTimeout(aiTextTimers[side]);
  aiTextTimers[side]=setTimeout(()=>generateAIText(side),1200);
}

async function generateAIText(side){
  const st=pState[side];
  if(st.aiPending||st.fragments.length===0)return;
  st.aiPending=true;
  const frags=st.fragments.slice(-8).join(' / ');
  const isPoem=side==='l';
  try{
    const text=await callAIRaw(
`Eres un escritor creativo. A partir de estos fragmentos: "${frags}"
${isPoem
  ?'Escribe un POEMA breve (4-6 líneas) que respete y recombine las imágenes y palabras originales. Sé fiel al material. Usa saltos de línea.'
  :'Escribe una HISTORIA ultra-breve (4-6 frases) que integre los fragmentos dados, manteniéndose fiel al material original.'}
Responde SOLO con el texto, sin títulos ni explicaciones.`);
    st.aiText=text.trim();
  }catch(e){st.aiText=frags;}
  st.aiPending=false;
  const elId=side==='l'?'poem-text':'story-text';
  const el=document.getElementById(elId);
  if(el){
    const wasVisible=el.classList.contains('visible');
    // Phase 1: fade out
    el.classList.remove('visible');
    const delay=wasVisible?500:0; // wait for fade-out only if was visible
    setTimeout(()=>{
      // Update content while invisible
      el.innerHTML=esc(st.aiText).replace(/\n/g,'<br>');
      // Phase 2: set entering state (bright+blurred), then immediately transition to visible
      el.classList.add('entering');
      void el.offsetWidth; // force reflow
      el.classList.remove('entering');
      el.classList.add('visible');
    },delay);
  }
}

function drawConstellations(){
  ['l','r'].forEach(side=>{
    const cv=document.getElementById(side==='l'?'tcl':'tcr');
    if(!cv)return;
    // Ensure canvas is sized
    const panel=document.getElementById('panel-'+side);
    const pw=cv.clientWidth||(panel?panel.clientWidth:SIDE)||SIDE;
    const ph=cv.clientHeight||(panel?panel.clientHeight:H)||H||600;
    if(cv.width!==pw||cv.height!==ph){cv.width=pw;cv.height=ph;}
    const cx=cv.getContext('2d');
    cx.clearRect(0,0,pw,ph);
    const rgb=side==='l'?'10,239,203':'201,162,39';
    const st=pState[side];
    const inv=side==='r'; // invert Y

    function nx(i){return SX[i]*pw;}
    function ny(i){return inv?(1-SY[i])*ph:SY[i]*ph;}

    // Base tree edges (very faint)
    cx.beginPath();
    cx.strokeStyle=`rgba(${rgb},.04)`;cx.lineWidth=0.4;
    for(const[a,b] of SEDGES){cx.moveTo(nx(a),ny(a));cx.lineTo(nx(b),ny(b));}
    cx.stroke();

    // Constellation edges between active nodes
    const active=st.nodes.map((n,i)=>n.active?i:-1).filter(x=>x>=0);
    if(active.length>1){
      // Tree edges between active nodes (brighter)
      for(const[a,b] of SEDGES){
        if(st.nodes[a].active&&st.nodes[b].active){
          const g=Math.min(st.nodes[a].glow,st.nodes[b].glow);
          cx.beginPath();
          cx.strokeStyle=`rgba(${rgb},${.18*g})`;cx.lineWidth=.7;
          cx.moveTo(nx(a),ny(a));cx.lineTo(nx(b),ny(b));
          cx.stroke();
        }
      }
      // Sequential constellation line through active nodes
      cx.beginPath();
      cx.strokeStyle=`rgba(${rgb},.22)`;cx.lineWidth=.9;
      for(let i=0;i<active.length-1;i++){
        cx.moveTo(nx(active[i]),ny(active[i]));
        cx.lineTo(nx(active[i+1]),ny(active[i+1]));
      }
      cx.stroke();
    }

    // Nodes
    for(let i=0;i<10;i++){
      const n=st.nodes[i];
      const x=nx(i),y=ny(i);
      if(n.active){
        const g=n.glow;
        // Outer glow ring
        cx.beginPath();cx.arc(x,y,10*g,0,Math.PI*2);
        cx.fillStyle=`rgba(${rgb},${.04*g})`;cx.fill();
        // Inner ring
        cx.beginPath();cx.arc(x,y,5,0,Math.PI*2);
        cx.strokeStyle=`rgba(${rgb},${.5*g})`;cx.lineWidth=.8;cx.stroke();
        // Core dot
        cx.beginPath();cx.arc(x,y,2.5,0,Math.PI*2);
        cx.fillStyle=`rgba(${rgb},${.85*g})`;cx.fill();
      } else {
        // Inactive: tiny dim dot
        cx.beginPath();cx.arc(x,y,1.5,0,Math.PI*2);
        cx.fillStyle=`rgba(${rgb},.1)`;cx.fill();
      }
    }
  });
}

// ══════════════════════════════════════════
// FX
// ══════════════════════════════════════════
function triggerDissolve(txt){
  const el=document.getElementById('wed-row');if(!el)return;
  const r=el.getBoundingClientRect();
  const chars=[...txt].filter(c=>c.trim()).slice(0,18);
  for(let i=0;i<chars.length;i++){
    const ang=-Math.PI*.5+(-0.5+Math.random())*0.9,spd=1.6+Math.random()*2.8;
    floaters.push({x:r.left+Math.random()*r.width,y:r.top+r.height*.6,
      ch:chars[i],color:`hsl(${38+Math.random()*18},80%,${58+Math.random()*14}%)`,
      life:1,vy:Math.sin(ang)*spd,vx:Math.cos(ang)*spd*(Math.random()-.5)*1.4,
      sz:8+Math.random()*6});
  }
}

// ══════════════════════════════════════════
// UI
// ══════════════════════════════════════════
function renderEditor(){
  const el=document.getElementById('wed');
  if(pending_text){el.innerHTML=`<span class="edp">${esc(pending_text)}</span>`;return;}
  const full=editor_buf+(editor_buf&&current_word?' ':'')+current_word;
  el.innerHTML=full?`<span class="edt">${esc(full)}</span><span class="edc"></span>`:`<span class="edc"></span>`;
}
function renderVerse(){
  const el=document.getElementById('spoem');
  if(verse.length){el.className='';el.textContent=verse.join(' ');}
  else{el.className='empty';el.textContent='· · ·';}
}
function renderSnakeMission(){document.getElementById('s-mis').textContent=SM[sMis%SM.length].t;}
function renderWriterMission(){document.getElementById('w-mis').textContent=WM[wMis%WM.length].t;}
function updateLives(){
  const sl=document.getElementById('s-lives');sl.textContent='♦'.repeat(sLiv)+'♢'.repeat(Math.max(0,LIVES-sLiv));sl.style.color=sLiv<=1?'#e02840':'var(--cyan)';
  const wl=document.getElementById('w-lives');wl.textContent='♦'.repeat(wLiv)+'♢'.repeat(Math.max(0,LIVES-wLiv));wl.style.color=wLiv<=1?'#e02840':'var(--gold)';
}
function updatePts(){document.getElementById('s-pts').textContent=sPts+'pt';document.getElementById('w-pts').textContent=wPts+'pt';}
function showAI(v){document.getElementById('aiind').style.display=v?'block':'none';}
function toast(msg,cls,big){
  const el=document.createElement('div');el.className='toast'+(cls?' '+cls:'');
  if(big){const ls=msg.split('\n');el.innerHTML=`<div class="t1">${esc(ls.slice(0,-1).join(' '))}</div><div class="t2">${esc(ls[ls.length-1])}</div>`;}
  else el.textContent=msg;
  document.getElementById('toasts').prepend(el);setTimeout(()=>el.remove(),4100);
}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// ══════════════════════════════════════════
// DRAW — KEY PERF: ZERO shadowBlur on body segments
// ══════════════════════════════════════════
function draw(now){
  if(shk>.1){CX.save();CX.translate((Math.random()-.5)*shk,(Math.random()-.5)*shk);shk*=.68;}

  CX.fillStyle='#04020a';CX.fillRect(0,0,W,H);
  if(!cachedVig){
    cachedVig=CX.createRadialGradient(W/2,H/2,0,W/2,H/2,Math.max(W,H)*.72);
    cachedVig.addColorStop(0,'rgba(14,5,42,.32)');cachedVig.addColorStop(1,'rgba(0,0,0,0)');
  }
  CX.fillStyle=cachedVig;CX.fillRect(0,0,W,H);

  // BG glyphs — precomputed, no shadow
  CX.textAlign='center';CX.textBaseline='middle';
  let lastGSz='';
  for(const g of bgGlyphs){
    g.x=(g.x+g.dx+W)%W;
    const a=g.a*(0.3+0.7*Math.sin(now*g.sp+g.ph));
    const fs=`${g.sz|0}px 'Cinzel Decorative',serif`;
    if(CX.font!==fs)CX.font=fs;
    CX.fillStyle=`rgba(201,162,39,${a.toFixed(3)})`;
    CX.fillText(g.ch,g.x,g.y);
  }

  // Grid — single batched path
  CX.beginPath();
  for(let x=GL;x<=GR+SZ;x+=SZ){CX.moveTo(x,GT);CX.lineTo(x,GB+SZ);}
  for(let y=GT;y<=GB+SZ;y+=SZ){CX.moveTo(GL,y);CX.lineTo(GR+SZ,y);}
  CX.strokeStyle='rgba(201,162,39,.007)';CX.lineWidth=.35;CX.stroke();

  // Particles — batched by color group? Just no shadow
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.vx*=.85;p.vy*=.85;p.life-=p.decay;
    if(p.life<=0){particles.splice(i,1);continue;}
    CX.globalAlpha=p.life*p.life;CX.fillStyle=p.color;
    CX.fillRect(p.x-p.sz/2,p.y-p.sz/2,p.sz,p.sz);
  }
  CX.globalAlpha=1;

  // Floaters — ONE shadowBlur pass only
  CX.textAlign='center';CX.textBaseline='middle';
  // Set shadow once, draw all, clear once
  CX.shadowBlur=4;
  const fFont=`italic ${SZ*.75|0}px 'IM Fell English',serif`;
  CX.font=fFont;
  for(let i=floaters.length-1;i>=0;i--){
    const f=floaters[i];f.x+=f.vx||0;f.y+=f.vy;f.vy-=.045;f.life-=.025;
    if(f.life<=0){floaters.splice(i,1);continue;}
    const sz=f.sz||(SZ*.75|0);
    const nf=`italic ${sz}px 'IM Fell English',serif`;
    if(CX.font!==nf)CX.font=nf;
    CX.globalAlpha=f.life*f.life;
    CX.shadowColor=f.color;
    CX.fillStyle=f.color;CX.fillText(f.ch,f.x,f.y);
  }
  CX.shadowBlur=0;CX.globalAlpha=1;

  // ── SNAKE ── PERF: no shadowBlur on body, only head ──
  const tickMs=1000/SPD;
  lerpT=Math.min(1,(now-lastMov)/LERP_MS);
  const t=lerpT*lerpT*(3-2*lerpT);
  // Guard against wrap-around artifact: don't lerp if crossing boundary
  let ihx,ihy;
  const dx=headX-prevX,dy=headY-prevY;
  if(Math.abs(dx)>(GR-GL)/2||Math.abs(dy)>(GB-GT)/2){ihx=headX;ihy=headY;}
  else{ihx=prevX+dx*t;ihy=prevY+dy*t;}

  const sc=segChars(),n=snake.length;
  const sOff=0; // segChars now returns t[0..n], so pos=i directly
  const{valEnd,pendEnd}=zoneEnds();

  // Connector (single path)
  if(n>1){
    CX.beginPath();
    for(let i=0;i<Math.min(n-1,18);i++){
      const ax=i===0?ihx:snake[i][0],ay=i===0?ihy:snake[i][1];
      CX.moveTo(ax+SZ/2,ay+SZ/2);CX.lineTo(snake[i+1][0]+SZ/2,snake[i+1][1]+SZ/2);
    }
    CX.strokeStyle='rgba(10,239,203,.032)';CX.lineWidth=.45;CX.stroke();
  }

  // Body segments — single loop, NO shadow, precomputed pulse
  const bodyFont=`bold ${SZ*.7|0}px 'IM Fell English',serif`;
  CX.font=bodyFont;CX.textAlign='center';CX.textBaseline='middle';
  const pendPulse=.5+.5*Math.sin(now*.0026);  // one sin per frame, not per segment

  for(let i=n-1;i>=0;i--){
    const sx=i===0?ihx:snake[i][0],sy=i===0?ihy:snake[i][1];
    const f=1-i/n,isH=i===0;
    const pos=sOff+i,isVal=pos<valEnd,isPend=pos>=valEnd&&pos<pendEnd,isEd=pos>=pendEnd;

    // Background
    if(isH){
      CX.strokeStyle='rgba(10,239,203,.55)';CX.lineWidth=1;
      CX.strokeRect(sx+2,sy+2,SZ-4,SZ-4);
      CX.fillStyle='rgba(10,239,203,.07)';CX.fillRect(sx+1,sy+1,SZ-2,SZ-2);
    } else if(isVal){
      // Precomputed ints, no template string math
      const g=44+f*100|0,b=58+f*86|0,a=.055+f*.23;
      CX.fillStyle=`rgba(0,${g},${b},${a})`;
      CX.fillRect(sx+1,sy+1,SZ-2,SZ-2);
    } else if(isPend){
      const a=(.035+f*.075)*pendPulse;
      CX.fillStyle=`rgba(82,52,0,${a})`;CX.fillRect(sx+1,sy+1,SZ-2,SZ-2);
    } else if(isEd){
      CX.fillStyle=`rgba(60,4,38,${.035+f*.085})`;CX.fillRect(sx+1,sy+1,SZ-2,SZ-2);
    }

    // Character (no shadow on body)
    const ch=sc[i]||' ';
    if(!ch.trim())continue;
    if(isH){
      // Head: single shadowBlur only
      CX.shadowColor='rgba(10,239,203,.32)';CX.shadowBlur=4;
      CX.fillStyle='rgba(158,255,228,.9)';
      CX.fillText(ch,sx+SZ/2,sy+SZ/2);
      CX.shadowBlur=0;
    } else if(isVal){
      const r2=210+f*22|0,g2=142+f*68|0,b2=24+f*34|0,a2=.4+f*.38;
      CX.fillStyle=`rgba(${r2},${g2},${b2},${a2})`;
      CX.fillText(ch,sx+SZ/2,sy+SZ/2);
    } else if(isPend){
      const a2=(.26+f*.26)*pendPulse;
      CX.fillStyle=`rgba(190,136,14,${a2})`;
      CX.fillText(ch,sx+SZ/2,sy+SZ/2);
    } else if(isEd){
      CX.fillStyle=`rgba(188,50,146,${.28+f*.26})`;
      CX.fillText(ch,sx+SZ/2,sy+SZ/2);
    }
  }

  // Head eyes (after loop so they render on top)
  if(n>0){
    const ex=dir==='LEFT'?ihx+5:ihx+SZ-6;
    CX.fillStyle='rgba(10,239,203,.65)';
    CX.fillRect(ex,ihy+5,2,2);CX.fillRect(ex,ihy+SZ-7,2,2);
  }

  // Apples
  CX.textAlign='center';CX.textBaseline='middle';
  const af=`bold ${SZ*.4|0}px 'Space Mono',monospace`;
  if(appleR){
    const p=.4+.6*Math.sin(now*.007);
    CX.fillStyle=`rgba(218,32,52,${.48+.4*p})`;
    CX.beginPath();CX.arc(appleR.x+SZ/2,appleR.y+SZ/2,SZ*.38,0,Math.PI*2);CX.fill();
    CX.font=af;CX.fillStyle='rgba(255,200,200,.82)';CX.fillText('✕',appleR.x+SZ/2,appleR.y+SZ/2+1);
  }
  if(appleM){
    const p=.4+.6*Math.sin(now*.006+1.8);
    CX.fillStyle=`rgba(206,36,168,${.48+.4*p})`;
    CX.beginPath();CX.arc(appleM.x+SZ/2,appleM.y+SZ/2,SZ*.38,0,Math.PI*2);CX.fill();
    CX.font=`bold ${SZ*.36|0}px 'Space Mono',monospace`;CX.fillStyle='rgba(255,154,232,.82)';CX.fillText('⊗',appleM.x+SZ/2,appleM.y+SZ/2+1);
  }

  if(shk>.1)CX.restore();else shk=0;
}

// ══════════════════════════════════════════
// LOOP
// ══════════════════════════════════════════
function loop(now){
  if(!running)return;
  if(now-lastMov>=1000/SPD)tickSnake(now);
  updateTimers(now);draw(now);
  requestAnimationFrame(loop);
}

// ══════════════════════════════════════════
// INPUT
// ══════════════════════════════════════════
const OPP={UP:'DOWN',DOWN:'UP',LEFT:'RIGHT',RIGHT:'LEFT'};
const DM={ArrowUp:'UP',ArrowDown:'DOWN',ArrowLeft:'LEFT',ArrowRight:'RIGHT'};
document.addEventListener('keydown',e=>{
  if(!running)return;
  if(DM[e.key]){e.preventDefault();if(DM[e.key]!==OPP[dir])nDir=DM[e.key];return;}
  if(e.key==='Enter'){e.preventDefault();writerSubmit();return;}
  if(e.key==='Backspace'){e.preventDefault();doBackspace();return;}
  if(e.key===' '){e.preventDefault();confirmWord();return;}
  if(e.key.length===1&&!e.ctrlKey&&!e.metaKey&&!e.altKey){e.preventDefault();typeLetter(e.key);}
});

// ══════════════════════════════════════════
// GAME OVER
// ══════════════════════════════════════════
function gameOver(){
  running=false;
  const wn=sPts>wPts?'SERPIENTE':sPts<wPts?'ESCRITOR':'EMPATE';
  const col=sPts>wPts?'var(--cyan2)':sPts<wPts?'var(--gold2)':'#a78bfa';
  document.getElementById('ov-res').innerHTML=`<span style="color:${col}">${wn} GANA</span><br><span style="font-size:12px;color:var(--w2);font-family:'Space Mono',monospace">SERPIENTE ${sPts} · ESCRITOR ${wPts}</span>`;
  document.getElementById('ov').querySelector('h1').textContent='FIN';
  document.getElementById('ov').querySelector('.obtn').textContent='▶ JUGAR DE NUEVO';
  document.getElementById('ov').style.display='flex';
}

// ══════════════════════════════════════════
// START
// ══════════════════════════════════════════
function startGame(){
  if(!geminiKey){toast('introduce tu Gemini API key primero','tr');return;}
  if(document.getElementById('mis-ed').classList.contains('open')){getMissions('s');getMissions('w');}
  shuffleMissions();
  document.getElementById('ov').style.display='none';
  document.getElementById('ov-res').innerHTML='';
  document.getElementById('ov').querySelector('h1').textContent='SCRIPTURA';
  document.getElementById('ddisp').textContent=DLABEL[difficulty];
  // Use double-rAF so the browser has done layout (HUD heights are real)
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    resize();updateGrid();
    clearPanels();
    drawConstellations();
    initBg();initSnake();
    appleR=null;appleM=null;sLiv=wLiv=LIVES;sPts=wPts=0;sMis=wMis=0;
    aiPending=false;verseTimerDone=false;particles=[];floaters=[];shk=0;
    document.getElementById('sabwarn').style.display='none';
    renderEditor();renderVerse();renderSnakeMission();renderWriterMission();
    updateLives();updatePts();
    // Place apples — guaranteed valid coords now
    placeApples();
    const now=performance.now();lastMov=wTick=sTick=lastTA=now;
    running=true;requestAnimationFrame(loop);
  }));
}

// Init
resize();
drawConstellations();
CX.fillStyle='#04020a';CX.fillRect(0,0,W||innerWidth,H||innerHeight);
shuffleMissions();
</script>
</body>
</html>
